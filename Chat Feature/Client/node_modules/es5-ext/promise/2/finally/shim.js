"use strict";

var ensurePlainFunction = require("es5-ext/object/ensure-plain-function")
  , isThenable          = require("es5-ext/object/is-thenable")
  , ensureThenable      = require("es5-ext/object/ensure-thenable");

var resolveCallback = function (callback, next) {
	var callbackResult = callback();
	if (!isThenable(callbackResult)) return next();
	return callbackResult.then(next);
};

module.exports = function (callback) {
	ensureThenable(this);
	ensurePlainFunction(callback);
	return this.then(
		function (result) {
			return resolveCallback(callback, function () { return result; });
		},
		function (error) {
			return resolveCallback(callback, function () { throw error; });
		}
	);
};
